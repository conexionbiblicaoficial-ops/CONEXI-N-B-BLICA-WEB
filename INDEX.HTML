<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Conexi√≥n B√≠blica ‚Äî Landing + Biblioteca</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#07070a; --bg2:#0b0b10;
      --surface:#101018; --surface2:#141424;
      --text:#f4f4f7; --muted:#b8b8c6;

      --gold:#e18c29; --gold2:#eaae4e; --cream:#f2c87a;
      --copper:#b14d09; --brown:#501903;

      --shadow:0 18px 50px rgba(0,0,0,.45);
      --r:18px; --r2:26px;
      --max:1160px;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(225,140,41,.22), transparent 60%),
        radial-gradient(700px 500px at 85% 20%, rgba(242,200,122,.14), transparent 55%),
        radial-gradient(700px 500px at 70% 90%, rgba(176,77,9,.15), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2) 65%, #07070b);
      min-height:100vh;
    }

    a{color:inherit;text-decoration:none}
    .container{width:min(var(--max), calc(100% - 40px)); margin:0 auto}

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter:blur(10px);
      background:rgba(7,7,10,.55);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbar__inner{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 0; /* ‚úÖ un poco m√°s para el logo grande */
      gap:14px;
    }

    .brand{display:flex;align-items:center;gap:12px;min-width:220px}
    .brand img{
      width:88px; height:88px; /* ‚úÖ DOBLE (antes 44x44) */
      object-fit:contain;
      border-radius:24px; /* proporcional */
      background: radial-gradient(circle at 30% 30%, rgba(242,200,122,.28), rgba(16,16,24,0) 60%);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .brand__name{line-height:1.05}
    .brand__name strong{display:block;font-weight:800;letter-spacing:.2px}
    .brand__name span{color:var(--muted);font-size:12.5px}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .pill{
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(16,16,24,.35);
      color:rgba(244,244,247,.92);
      font-weight:800;font-size:13px;
      transition:.15s ease;
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{border-color:rgba(225,140,41,.35); box-shadow:0 0 0 6px rgba(225,140,41,.08)}
    .pill[data-active="true"]{
      border-color:rgba(225,140,41,.55);
      background:linear-gradient(180deg, rgba(225,140,41,.18), rgba(16,16,24,.35));
    }

    .actions{display:flex;gap:10px;align-items:center;justify-content:flex-end;min-width:220px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(16,16,24,.35);
      color:var(--text);
      font-weight:800;font-size:13px;
      transition:.15s ease;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{border-color:rgba(242,200,122,.35); box-shadow:0 0 0 6px rgba(242,200,122,.08)}
    .btn--primary{
      border-color:rgba(225,140,41,.45);
      background:linear-gradient(180deg, rgba(225,140,41,.30), rgba(176,77,9,.18));
    }
    .btn--primary:hover{box-shadow:0 0 0 6px rgba(225,140,41,.12)}

    main{padding:18px 0 30px}
    .card{
      background:linear-gradient(180deg, rgba(16,16,24,.55), rgba(16,16,24,.28));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r2);
      box-shadow:var(--shadow);
    }

    .page{display:none}
    .page[data-show="true"]{display:block}

    .hero{padding:18px}
    .hero__grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:stretch;
    }
    .hero__main{padding:26px; position:relative; overflow:hidden}
    .glow{
      position:absolute; inset:-1px;
      background:
        radial-gradient(600px 250px at 18% 10%, rgba(225,140,41,.22), transparent 55%),
        radial-gradient(500px 240px at 85% 35%, rgba(242,200,122,.16), transparent 55%),
        radial-gradient(500px 240px at 55% 105%, rgba(176,77,9,.14), transparent 60%);
      pointer-events:none;
      opacity:.95;
    }
    .hero h1{
      position:relative; margin:0 0 10px;
      font-size:clamp(28px,3.6vw,44px);
      letter-spacing:-.6px; line-height:1.05;
    }
    .mark{
      background:linear-gradient(90deg,var(--gold2),var(--cream));
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .hero p{
      position:relative;margin:0 0 16px;
      color:rgba(244,244,247,.82);
      font-size:15.5px; line-height:1.5; max-width:65ch;
    }
    .hero__cta{position:relative; display:flex; gap:12px; flex-wrap:wrap}

    .hero__side{padding:18px; display:flex; flex-direction:column; gap:12px}
    .stat{
      padding:14px;border-radius:var(--r);
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,10,14,.45);
    }
    .stat strong{display:block;font-size:12px;color:rgba(244,244,247,.85);letter-spacing:.2px}
    .stat span{display:block;margin-top:6px;color:var(--muted);font-size:13px;line-height:1.4}

    section{padding:10px 0}
    .section-title{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin:14px 0 10px;
    }
    .section-title h2{margin:0;font-size:18px;letter-spacing:-.2px}
    .section-title p{margin:0;color:var(--muted);font-size:13px}

    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .tile{
      padding:16px;border-radius:var(--r);
      border:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(20,20,36,.45), rgba(12,12,18,.25));
      transition:.15s ease;
      position:relative; overflow:hidden; min-height:152px;
    }
    .tile::before{
      content:""; position:absolute; inset:-2px;
      background: radial-gradient(450px 160px at 20% 10%, rgba(225,140,41,.16), transparent 55%);
      opacity:.9; pointer-events:none;
    }
    .tile:hover{transform:translateY(-2px); border-color:rgba(225,140,41,.30); box-shadow:0 0 0 6px rgba(225,140,41,.08)}
    .tile h3{position:relative;margin:0 0 8px;font-size:15px}
    .tile p{position:relative;margin:0 0 12px;color:rgba(244,244,247,.78);font-size:13px;line-height:1.45}
    .badge{
      position:relative; display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(242,200,122,.25);
      background:rgba(225,140,41,.10);
      color:rgba(244,244,247,.92);
      font-weight:900;font-size:12px;
    }

    .videos{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .video{
      border-radius:var(--r); overflow:hidden;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(0,0,0,.25);
      aspect-ratio:16/9;
      position:relative;
    }

    /* Miniaturas clicables (sin embed) */
    .video-link{display:block}
    .video-link img{width:100%; height:100%; object-fit:cover; display:block; filter:brightness(.92)}
    .video-link .play{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:64px; height:64px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45);
      font-weight:900; font-size:22px;
    }
    .video-link:hover .play{background:rgba(225,140,41,.25); border-color:rgba(225,140,41,.5)}

    .panel{padding:16px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:rgba(244,244,247,.85); font-weight:800}
    input[type="text"], input[type="url"], textarea, select{
      background:rgba(10,10,14,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      outline:none;
      font-size:13.5px;
    }
    textarea{min-height:92px; resize:vertical; line-height:1.4}
    input:focus, textarea:focus, select:focus{
      border-color:rgba(225,140,41,.35);
      box-shadow:0 0 0 6px rgba(225,140,41,.08);
    }
    .hint{font-size:12px; color:var(--muted); line-height:1.35}
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin:10px 0 12px;
    }
    .toolbar-left, .toolbar-right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .hr{height:1px; background:rgba(255,255,255,.07); margin:14px 0}

    /* Library */
    .lib-grid{display:grid; grid-template-columns: repeat(4, 1fr); gap: 14px;}
    .char-card{
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(20,20,36,.45), rgba(12,12,18,.25));
      border-radius: var(--r);
      overflow:hidden;
      transition:.15s ease;
      display:flex;
      flex-direction:column;
      min-height: 300px;
      position:relative;
    }
    .char-card:hover{
      transform: translateY(-2px);
      border-color: rgba(225,140,41,.30);
      box-shadow: 0 0 0 6px rgba(225,140,41,.08);
    }
    .thumb{
      aspect-ratio: 1/1;
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .thumb .noimg{color:var(--muted); font-size:12px; padding:16px; text-align:center}
    .char-body{padding:12px 12px 10px; display:flex; flex-direction:column; gap:8px; flex:1}
    .char-title{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .char-title strong{font-size:14px; letter-spacing:-.2px}
    .tagline{color:rgba(244,244,247,.78); font-size:12.5px; line-height:1.35}
    .meta{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-size:11.5px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,10,14,.35);
      color: rgba(244,244,247,.86);
      max-width: 100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip--ok{
      border-color: rgba(120,255,170,.22);
      background: rgba(120,255,170,.08);
    }
    .char-actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:auto}
    .mini{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(16,16,24,.25);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
    }
    .mini:hover{border-color: rgba(242,200,122,.35); box-shadow:0 0 0 6px rgba(242,200,122,.08)}
    .mini--gold{border-color: rgba(225,140,41,.40); background: rgba(225,140,41,.10)}
    .mini--danger{border-color: rgba(255,100,100,.35); background: rgba(255,80,80,.08)}

    .modal-backdrop{
      position:fixed; inset:0; z-index:80;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .modal-backdrop[data-open="true"]{display:flex}
    .modal{
      width:min(980px, 100%);
      border-radius: var(--r2);
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(16,16,24,.85), rgba(16,16,24,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal-head{
      padding: 14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modal-head strong{font-size:14px}
    .modal-body{padding: 14px 16px}
    .modal-foot{
      padding: 14px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }

    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(10,10,14,.35);
      user-select:none;
    }
    .toggle input{transform: scale(1.15);}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(10,10,14,.85);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 10px 14px;
      color: rgba(244,244,247,.92);
      font-weight:900;
      font-size:12.5px;
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition:.18s ease;
      z-index: 120;
    }
    .toast[data-show="true"]{opacity:1; pointer-events:auto}

    footer{padding: 18px 0 34px; color: rgba(244,244,247,.72)}
    .footer-card{
      padding: 16px; border-radius: var(--r);
      border:1px solid rgba(255,255,255,.08);
      background: rgba(16,16,24,.28);
      display:flex; align-items:center; justify-content:space-between; gap: 12px; flex-wrap:wrap;
    }
    .small{font-size:12.5px; color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}

    @media (max-width: 980px){
      .hero__grid{grid-template-columns:1fr}
      .actions{min-width:auto}
      .grid3{grid-template-columns:1fr}
      .videos{grid-template-columns:1fr}
      .row{grid-template-columns:1fr}
      .lib-grid{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 520px){
      .lib-grid{grid-template-columns:1fr}
    }
  </style>
</head>

<body>
  <!-- CONFIG -->
  <script>
    window.CB_CONFIG = {
      channelName: "Conexi√≥n B√≠blica",
      tagline: "Historias, quizzes y ense√±anzas para conectar con la Palabra.",

      youtubeChannelUrl: "https://www.youtube.com/channel/UCZIOcY9u5yYWPsohXooSbkw",
      subscribeUrl: "https://www.youtube.com/channel/UCZIOcY9u5yYWPsohXooSbkw?sub_confirmation=1",

      landing: {
        headline: "Conexi√≥n B√≠blica",
        subheadline: "Quizzes ‚Ä¢ Diccionario ‚Ä¢ Shorts ‚Äî contenido b√≠blico con ritmo y claridad",

        primaryCtaText: "Ver Playlists",
        primaryCtaUrl: "https://www.youtube.com/channel/UCZIOcY9u5yYWPsohXooSbkw/playlists",

        secondaryCtaText: "Suscribirme",
        secondaryCtaUrl: "https://www.youtube.com/channel/UCZIOcY9u5yYWPsohXooSbkw?sub_confirmation=1",

        seriesLinks: {
          quiz: "https://youtube.com/playlist?list=PLOrAJ7Jx3yuT6RcahRoVnAG8-qANMx7xN&si=YF-0j_8TyYo9vPYK",
          diccionario: "https://www.youtube.com/channel/UCZIOcY9u5yYWPsohXooSbkw",
          shorts: "https://www.youtube.com/channel/UCZIOcY9u5yYWPsohXooSbkw/shorts"
        },

        rules: [
          "Contenido claro y directo",
          "Series por playlists",
          "Quizzes para retenci√≥n",
          "Shorts para alcance"
        ],

        featuredVideos: ["dMDV_FU8PV0","0R1YuaPn2t0"]
      },

      library: {
        maxImagePx: 768,
        imageFormat: "image/webp",
        imageQuality: 0.82,
        baseStyle: "Disney/Pixar 3D cinematogr√°fico, modelado 3D limpio, ojos grandes, texturas suaves, profundidad de campo, iluminaci√≥n c√°lida golden hour, fondo oscuro limpio, color grading c√°lido, ultra clean 3D, high detail, soft textures",
        negative: "texto, watermark, logo, blur, low quality, deformed, extra limbs, extra fingers, bad hands, creepy, gore, nudity"
      }
    };
  </script>

  <header class="topbar">
    <div class="container topbar__inner">
      <a class="brand" href="#landing" aria-label="Inicio Conexi√≥n B√≠blica">
        <img src="logo.png" alt="Logo Conexi√≥n B√≠blica" />
        <div class="brand__name">
          <strong id="brandName">Conexi√≥n B√≠blica</strong>
          <span>Landing + Biblioteca de personajes</span>
        </div>
      </a>

      <div class="tabs" role="tablist" aria-label="Pesta√±as">
        <button class="pill" id="tabLanding" role="tab" aria-controls="pageLanding">Landing</button>
        <button class="pill" id="tabLibrary" role="tab" aria-controls="pageLibrary">Biblioteca</button>
      </div>

      <div class="actions">
        <a class="btn" id="btnYoutube" href="#" target="_blank" rel="noopener">YouTube</a>
        <a class="btn btn--primary" id="btnSubscribe" href="#" target="_blank" rel="noopener">Suscribirme</a>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- LANDING -->
    <div class="page" id="pageLanding">
      <section class="hero">
        <div class="hero__grid">
          <div class="card hero__main">
            <div class="glow" aria-hidden="true"></div>
            <h1><span class="mark" id="landingHeadline">Conexi√≥n B√≠blica</span></h1>
            <p id="landingSubheadline">Quizzes ‚Ä¢ Diccionario ‚Ä¢ Shorts‚Ä¶</p>
            <div class="hero__cta">
              <a class="btn btn--primary" id="landingPrimaryCta" href="#" target="_blank" rel="noopener">Ver Playlists</a>
              <a class="btn" id="landingSecondaryCta" href="#" target="_blank" rel="noopener">Suscribirme</a>
              <button class="btn" id="btnCopyLanding">Copiar texto para descripci√≥n</button>
            </div>
          </div>

          <aside class="card hero__side">
            <div class="stat">
              <strong>C√≥mo funciona</strong>
              <span id="landingRulesText">Reglas del canal‚Ä¶</span>
            </div>
            <div class="stat">
              <strong>CTA recomendado</strong>
              <span>üí¨ ‚ÄúComenta, comparte y suscr√≠bete para el pr√≥ximo.‚Äù</span>
            </div>
            <div class="stat">
              <strong>Estilo visual</strong>
              <span class="mono">oscuro + dorado c√°lido</span>
            </div>
          </aside>
        </div>
      </section>

      <section>
        <div class="section-title">
          <div>
            <h2>Series del canal</h2>
            <p>Accesos directos.</p>
          </div>
        </div>

        <div class="grid3">
          <a class="tile" id="tileQuiz" href="#" target="_blank" rel="noopener">
            <span class="badge">üéØ Quiz B√≠blico</span>
            <h3>Retenci√≥n alta con ritmo</h3>
            <p>Directo a la playlist de Quiz B√≠blico.</p>
          </a>
          <a class="tile" id="tileDiccionario" href="#" target="_blank" rel="noopener">
            <span class="badge">üìö Diccionario B√≠blico</span>
            <h3>Conceptos explicados</h3>
            <p>De momento te lleva al canal.</p>
          </a>
          <a class="tile" id="tileShorts" href="#" target="_blank" rel="noopener">
            <span class="badge">‚ö° Shorts</span>
            <h3>Vers√≠culos potentes</h3>
            <p>Impacto r√°pido: un vers√≠culo, una idea, una llamada.</p>
          </a>
        </div>
      </section>

      <section>
        <div class="section-title">
          <div>
            <h2>Videos destacados</h2>
            <p>Miniaturas clicables (sin embed).</p>
          </div>
        </div>

        <div class="videos">
          <a class="video video-link" id="vidLink1" href="#" target="_blank" rel="noopener">
            <img id="vidThumb1" alt="Video destacado 1" />
            <span class="play">‚ñ∂</span>
          </a>

          <a class="video video-link" id="vidLink2" href="#" target="_blank" rel="noopener">
            <img id="vidThumb2" alt="Video destacado 2" />
            <span class="play">‚ñ∂</span>
          </a>
        </div>
      </section>

      <section>
        <div class="section-title">
          <div>
            <h2>Ajustes r√°pidos</h2>
            <p>Se guardan en tu navegador.</p>
          </div>
        </div>

        <div class="card panel">
          <div class="row">
            <div class="field">
              <label>T√≠tulo (headline)</label>
              <input type="text" id="setHeadline" />
            </div>
            <div class="field">
              <label>Subt√≠tulo</label>
              <input type="text" id="setSubheadline" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="field">
              <label>CTA principal (texto)</label>
              <input type="text" id="setCta1Text" />
            </div>
            <div class="field">
              <label>CTA principal (URL)</label>
              <input type="url" id="setCta1Url" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="field">
              <label>CTA secundario (texto)</label>
              <input type="text" id="setCta2Text" />
            </div>
            <div class="field">
              <label>CTA secundario (URL)</label>
              <input type="url" id="setCta2Url" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="field">
              <label>Enlace tile: Quiz B√≠blico</label>
              <input type="url" id="setSeriesQuizUrl" />
            </div>
            <div class="field">
              <label>Enlace tile: Diccionario B√≠blico</label>
              <input type="url" id="setSeriesDiccionarioUrl" />
            </div>
          </div>

          <div class="field" style="margin-top:10px;">
            <label>Enlace tile: Shorts</label>
            <input type="url" id="setSeriesShortsUrl" />
          </div>

          <div class="field" style="margin-top:10px;">
            <label>Reglas (una por l√≠nea)</label>
            <textarea id="setRules"></textarea>
          </div>

          <div class="toolbar" style="margin-top:12px;">
            <div class="toolbar-left">
              <button class="btn btn--primary" id="btnSaveLanding">Guardar cambios</button>
              <button class="btn" id="btnResetLanding">Restablecer</button>
            </div>
            <div class="toolbar-right">
              <span class="hint">Se guarda en LocalStorage.</span>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- LIBRARY -->
    <div class="page" id="pageLibrary">
      <section>
        <div class="section-title">
          <div>
            <h2>Biblioteca de personajes</h2>
            <p>Sube tus personajes y guarda seeds + prompts (9:16 y 16:9).</p>
          </div>
        </div>

        <div class="card panel">
          <div class="toolbar">
            <div class="toolbar-left">
              <input type="text" id="search" placeholder="Buscar..." style="min-width:260px" />
              <select id="filterType">
                <option value="">Tipo: todos</option>
                <option>Patriarca</option>
                <option>Profeta</option>
                <option>Rey</option>
                <option>Sacerdote</option>
                <option>Disc√≠pulo</option>
                <option>Egipcio</option>
                <option>√Ångel</option>
                <option>Mujer</option>
                <option>Animal</option>
                <option>Otro</option>
              </select>

              <label class="toggle" title="Mostrar solo aprobados">
                <input type="checkbox" id="filterApproved" />
                <span class="hint" style="margin:0;color:rgba(244,244,247,.85);font-weight:900">Solo aprobados ‚úÖ</span>
              </label>

              <select id="sort">
                <option value="updated_desc">Orden: recientes</option>
                <option value="name_asc">Orden: nombre A‚ÜíZ</option>
                <option value="name_desc">Orden: nombre Z‚ÜíA</option>
              </select>
            </div>

            <div class="toolbar-right">
              <button class="btn btn--primary" id="btnAddNew">+ A√±adir personaje</button>
              <button class="btn" id="btnExport">Exportar JSON</button>
              <button class="btn" id="btnImport">Importar JSON</button>
              <button class="btn" id="btnClearAll">Vaciar biblioteca</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="row">
            <div class="field">
              <label>Subir personaje(s)</label>
              <input type="file" id="fileUpload" accept="image/*" multiple />
              <div class="hint">Se reduce autom√°ticamente. Luego editas cada tarjeta.</div>
            </div>
            <div class="field">
              <label>Compresi√≥n al subir</label>
              <div class="row" style="grid-template-columns:1fr 1fr; gap:10px">
                <div class="field">
                  <label style="font-weight:900; opacity:.9">M√°x. px</label>
                  <select id="imgMax">
                    <option value="512">512</option>
                    <option value="768" selected>768</option>
                    <option value="1024">1024</option>
                  </select>
                </div>
                <div class="field">
                  <label style="font-weight:900; opacity:.9">Calidad</label>
                  <select id="imgQ">
                    <option value="0.70">0.70</option>
                    <option value="0.82" selected>0.82</option>
                    <option value="0.90">0.90</option>
                  </select>
                </div>
              </div>
              <div class="hint">Si se llena el almacenamiento, baja a 512 y 0.70.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="field">
            <label>Base de prompts</label>
            <textarea id="baseStyle" style="min-height:76px;"></textarea>
          </div>

          <div class="field" style="margin-top:10px;">
            <label>Negativos</label>
            <input type="text" id="negative" />
          </div>

          <div class="toolbar" style="margin-top:12px;">
            <div class="toolbar-left">
              <button class="btn btn--primary" id="btnSavePromptBase">Guardar base</button>
            </div>
          </div>
        </div>
      </section>

      <section>
        <div class="lib-grid" id="libGrid"></div>
      </section>
    </div>

    <footer>
      <div class="footer-card">
        <div>
          <strong id="footName">Conexi√≥n B√≠blica</strong>
          <div class="small">¬© <span id="year"></span> ‚Äî Un solo HTML: Landing + Biblioteca (LocalStorage).</div>
        </div>
        <div class="small">Paleta: <span class="mono">#e18c29 #eaae4e #f2c87a #501903</span></div>
      </div>
    </footer>
  </main>

  <!-- MODAL -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Editor de personaje">
      <div class="modal-head">
        <strong id="modalTitle">A√±adir personaje</strong>
        <button class="btn" id="btnCloseModal">Cerrar</button>
      </div>

      <div class="modal-body">
        <div class="row">
          <div class="field">
            <label>Nombre</label>
            <input type="text" id="mName" placeholder="Ej: Mois√©s anciano v1" />
          </div>
          <div class="field">
            <label>Versi√≥n / etiqueta</label>
            <input type="text" id="mVersion" placeholder="Ej: v1 / v2 / aprobado" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Tipo</label>
            <select id="mType">
              <option>Patriarca</option><option>Profeta</option><option>Rey</option><option>Sacerdote</option>
              <option>Disc√≠pulo</option><option>Egipcio</option><option>√Ångel</option><option>Mujer</option>
              <option>Animal</option><option>Otro</option>
            </select>
          </div>
          <div class="field">
            <label>Serie / Libro</label>
            <input type="text" id="mSeries" placeholder="Ej: G√©nesis / √âxodo / Lucas 15" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Seed</label>
            <input type="text" id="mSeed" placeholder="Ej: Jacob_v1_seed_4127" />
          </div>
          <div class="field">
            <label>Tags (coma)</label>
            <input type="text" id="mTags" placeholder="Ej: quiz, exodo, patriarca" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Aprobado</label>
            <label class="toggle">
              <input type="checkbox" id="mApproved" />
              <span class="hint" style="margin:0;color:rgba(244,244,247,.85);font-weight:900">S√≠ ‚úÖ</span>
            </label>
          </div>
          <div class="field">
            <label>Acciones r√°pidas</label>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" id="btnGenPrompts">Generar prompts (9:16 + 16:9)</button>
              <button class="btn" id="btnClearPrompts">Vaciar prompts</button>
            </div>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Descripci√≥n (rasgos fijos)</label>
          <textarea id="mDesc" placeholder="Rasgos can√≥nicos, ropa, edad, etc."></textarea>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Prompt 9:16</label>
            <textarea id="mP916" placeholder="Prompt listo para copiar..."></textarea>
          </div>
          <div class="field">
            <label>Prompt 16:9</label>
            <textarea id="mP169" placeholder="Prompt listo para copiar..."></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div class="field">
            <label>Imagen (opcional)</label>
            <input type="file" id="mImageFile" accept="image/*" />
          </div>
          <div class="field">
            <label>Preview</label>
            <div class="thumb" style="border-radius:14px; border:1px solid rgba(255,255,255,.08);">
              <img id="mPreview" alt="Preview" style="display:none" />
              <div class="noimg" id="mNoImg">Sin imagen</div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" id="btnCopy916">Copiar 9:16</button>
        <button class="btn" id="btnCopy169">Copiar 16:9</button>
        <button class="btn btn--primary" id="btnSaveChar">Guardar</button>
      </div>
    </div>
  </div>

  <input type="file" id="importFile" accept="application/json" style="display:none" />
  <div class="toast" id="toast">Copiado ‚úÖ</div>

  <script>
    const $ = (id) => document.getElementById(id);
    const now = () => Date.now();
    const uid = () => Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);

    function toast(msg="Hecho ‚úÖ"){
      const t = $("toast");
      t.textContent = msg;
      t.dataset.show = "true";
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.dataset.show = "false", 1200);
    }

    async function copyText(txt){
      try{
        await navigator.clipboard.writeText(txt);
        toast("Copiado ‚úÖ");
      }catch{
        const ta = document.createElement("textarea");
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copiado ‚úÖ");
      }
    }

    // ‚úÖ Subo versi√≥n para que no te cargue valores antiguos del navegador
    const KEY_LANDING = "cb_landing_settings_v6";
    const KEY_LIBRARY = "cb_character_library_v2";
    const KEY_PROMPTBASE = "cb_prompt_base_v1";

    function defaultLandingFromConfig(){
      const C = window.CB_CONFIG || {};
      return JSON.parse(JSON.stringify(C.landing || {}));
    }

    function defaultPromptBase(){
      const C = window.CB_CONFIG || {};
      return {
        baseStyle: C.library?.baseStyle || "",
        negative: C.library?.negative || ""
      };
    }

    function loadPromptBase(){
      const saved = localStorage.getItem(KEY_PROMPTBASE);
      if(saved){
        try { return JSON.parse(saved); } catch {}
      }
      const d = defaultPromptBase();
      localStorage.setItem(KEY_PROMPTBASE, JSON.stringify(d));
      return d;
    }
    function savePromptBase(pb){ localStorage.setItem(KEY_PROMPTBASE, JSON.stringify(pb)); }

    function defaultCharacters(){
      return [
        {
          id: uid(),
          name: "Cordero Conexi√≥n B√≠blica",
          version: "v1",
          type: "Animal",
          series: "Marca / Identidad",
          seed: "Cordero_ConexionBiblica_v1",
          tags: ["cordero","logo","aprobado"],
          approved: true,
          desc: "Corderito beb√©, lana rizada blanca, ojos grandes marr√≥n brillantes, hocico corto con sonrisa sutil, orejas peque√±as interior rosado, mech√≥n espiral en la frente, pezu√±as negras redondeadas.",
          p916: "",
          p169: "",
          imageDataUrl: "",
          createdAt: now(),
          updatedAt: now()
        }
      ];
    }

    function loadLanding(){
      const saved = localStorage.getItem(KEY_LANDING);
      if(saved){
        try { return JSON.parse(saved); } catch {}
      }
      return defaultLandingFromConfig();
    }
    function saveLanding(data){ localStorage.setItem(KEY_LANDING, JSON.stringify(data)); }
    function resetLanding(){
      localStorage.removeItem(KEY_LANDING);
      applyLanding(defaultLandingFromConfig());
      fillLandingSettings(defaultLandingFromConfig());
      toast("Landing restablecida ‚úÖ");
    }

    function ytThumb(id){ return "https://img.youtube.com/vi/" + encodeURIComponent(id) + "/hqdefault.jpg"; }
    function ytWatchUrl(id){ return "https://www.youtube.com/watch?v=" + encodeURIComponent(id); }

    function applyLanding(L){
      const C = window.CB_CONFIG || {};
      $("brandName").textContent = C.channelName || "Conexi√≥n B√≠blica";
      $("footName").textContent = C.channelName || "Conexi√≥n B√≠blica";
      $("btnYoutube").href = C.youtubeChannelUrl || "#";
      $("btnSubscribe").href = C.subscribeUrl || "#";

      $("landingHeadline").textContent = L.headline || "Conexi√≥n B√≠blica";
      $("landingSubheadline").textContent = L.subheadline || "";
      $("landingPrimaryCta").textContent = L.primaryCtaText || "Ver";
      $("landingPrimaryCta").href = L.primaryCtaUrl || "#";
      $("landingSecondaryCta").textContent = L.secondaryCtaText || "Suscribirme";
      $("landingSecondaryCta").href = L.secondaryCtaUrl || (C.subscribeUrl || "#");

      const rules = (L.rules || []).map(r => "‚Ä¢ " + r).join("\n");
      $("landingRulesText").textContent = rules || "‚Ä¢ Contenido claro\n‚Ä¢ Series por playlists";

      const links = (L.seriesLinks || {});
      $("tileQuiz").href = links.quiz || "#";
      $("tileDiccionario").href = links.diccionario || "#";
      $("tileShorts").href = links.shorts || "#";

      const vids = (L.featuredVideos || []).slice(0,2);
      const v1 = vids[0] || "";
      const v2 = vids[1] || v1 || "";

      if(v1){
        $("vidLink1").href = ytWatchUrl(v1);
        $("vidThumb1").src = ytThumb(v1);
        $("vidLink1").style.display = "block";
      }else $("vidLink1").style.display = "none";

      if(v2){
        $("vidLink2").href = ytWatchUrl(v2);
        $("vidThumb2").src = ytThumb(v2);
        $("vidLink2").style.display = "block";
      }else $("vidLink2").style.display = "none";
    }

    function fillLandingSettings(L){
      $("setHeadline").value = L.headline || "";
      $("setSubheadline").value = L.subheadline || "";
      $("setCta1Text").value = L.primaryCtaText || "";
      $("setCta1Url").value = L.primaryCtaUrl || "";
      $("setCta2Text").value = L.secondaryCtaText || "";
      $("setCta2Url").value = L.secondaryCtaUrl || "";
      $("setRules").value = (L.rules || []).join("\n");

      const sl = (L.seriesLinks || {});
      $("setSeriesQuizUrl").value = sl.quiz || "";
      $("setSeriesDiccionarioUrl").value = sl.diccionario || "";
      $("setSeriesShortsUrl").value = sl.shorts || "";
    }

    function landingToDescriptionText(L){
      const C = window.CB_CONFIG || {};
      const lines = [];
      lines.push((L.headline || "Conexi√≥n B√≠blica") + " ‚úÖ");
      if(L.subheadline) lines.push(L.subheadline);
      lines.push("");
      lines.push("üìå Info");
      (L.rules || []).forEach(r => lines.push("‚Ä¢ " + r));
      lines.push("");
      lines.push("‚ñ∂Ô∏è Canal: " + (C.youtubeChannelUrl || ""));
      lines.push("üîî Suscr√≠bete: " + (C.subscribeUrl || ""));
      lines.push("");
      lines.push("üí¨ Comenta y comparte.");
      return lines.join("\n");
    }

    function loadLibrary(){
      const saved = localStorage.getItem(KEY_LIBRARY);
      if(saved){
        try {
          const data = JSON.parse(saved);
          if(Array.isArray(data)) return data;
        } catch {}
      }
      const d = defaultCharacters();
      localStorage.setItem(KEY_LIBRARY, JSON.stringify(d));
      return d;
    }
    function saveLibrary(list){ localStorage.setItem(KEY_LIBRARY, JSON.stringify(list)); }

    async function fileToCompressedDataUrl(file, maxPx, mime, quality){
      const dataUrl = await new Promise((res, rej)=>{
        const reader = new FileReader();
        reader.onload = () => res(reader.result);
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });

      const img = await new Promise((res, rej)=>{
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.src = dataUrl;
      });

      const w = img.width, h = img.height;
      const scale = Math.min(1, maxPx / Math.max(w, h));
      const nw = Math.max(1, Math.round(w * scale));
      const nh = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement("canvas");
      canvas.width = nw; canvas.height = nh;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, nw, nh);

      let out = "";
      try{
        out = canvas.toDataURL(mime, quality);
        if(!out || !out.startsWith("data:")) throw new Error("bad");
      }catch{
        out = canvas.toDataURL("image/jpeg", Math.min(0.9, Math.max(0.7, quality)));
      }
      return out;
    }

    function setTab(which){
      const isLanding = which === "landing";
      $("pageLanding").dataset.show = isLanding ? "true" : "false";
      $("pageLibrary").dataset.show = isLanding ? "false" : "true";
      $("tabLanding").dataset.active = isLanding ? "true" : "false";
      $("tabLibrary").dataset.active = isLanding ? "false" : "true";
      location.hash = isLanding ? "#landing" : "#biblioteca";
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function escapeHtml(str){
      return String(str || "").replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[s]));
    }

    let LIB = [];
    let editingId = null;

    function matchesQuery(ch, q){
      if(!q) return true;
      q = q.toLowerCase();
      const blob = [
        ch.name, ch.version, ch.seed, ch.desc, ch.type, ch.series,
        (ch.tags||[]).join(","),
        ch.p916, ch.p169
      ].join(" ").toLowerCase();
      return blob.includes(q);
    }

    function sortList(list, mode){
      const cp = list.slice();
      if(mode === "name_asc") cp.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "es"));
      else if(mode === "name_desc") cp.sort((a,b)=> (b.name||"").localeCompare(a.name||"", "es"));
      else cp.sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
      return cp;
    }

    function renderLibrary(){
      const grid = $("libGrid");
      const q = ($("search").value || "").trim();
      const mode = $("sort").value;
      const ft = $("filterType").value;
      const fa = $("filterApproved").checked;

      let filtered = LIB.filter(ch => matchesQuery(ch, q));
      if(ft) filtered = filtered.filter(ch => (ch.type || "") === ft);
      if(fa) filtered = filtered.filter(ch => !!ch.approved);

      filtered = sortList(filtered, mode);

      grid.innerHTML = "";
      if(!filtered.length){
        const empty = document.createElement("div");
        empty.className = "card panel";
        empty.innerHTML = `
          <div style="color:rgba(244,244,247,.85); font-weight:900;">No hay resultados.</div>
          <div class="hint" style="margin-top:6px;">Sube im√°genes o a√±ade personajes con ‚Äú+ A√±adir personaje‚Äù.</div>
        `;
        grid.appendChild(empty);
        return;
      }

      for(const ch of filtered){
        const card = document.createElement("div");
        card.className = "char-card";

        const imgHtml = ch.imageDataUrl
          ? `<img src="${ch.imageDataUrl}" alt="${escapeHtml(ch.name||"Personaje")}">`
          : `<div class="noimg">Sin imagen<br><span style="opacity:.8">Puedes subir una al editar</span></div>`;

        const tags = (ch.tags || []).slice(0,3).map(t => `<span class="chip">${escapeHtml(t)}</span>`).join("");

        card.innerHTML = `
          <div class="thumb">${imgHtml}</div>
          <div class="char-body">
            <div class="char-title">
              <strong>${escapeHtml(ch.name || "Sin nombre")}</strong>
              ${ch.approved ? `<span class="chip chip--ok">‚úÖ Aprobado</span>` : `<span class="chip">${escapeHtml(ch.version || "‚Äî")}</span>`}
            </div>
            <div class="tagline">${escapeHtml((ch.desc || "").slice(0, 105))}${(ch.desc||"").length>105?"‚Ä¶":""}</div>
            <div class="meta">
              ${ch.type ? `<span class="chip">${escapeHtml(ch.type)}</span>` : ""}
              ${ch.series ? `<span class="chip">${escapeHtml(ch.series)}</span>` : ""}
              ${ch.seed ? `<span class="chip">seed: ${escapeHtml(ch.seed)}</span>` : ""}
              ${tags}
            </div>
            <div class="char-actions">
              <button class="mini mini--gold" data-act="edit" data-id="${ch.id}">Editar</button>
              <button class="mini" data-act="copy916" data-id="${ch.id}">Copiar 9:16</button>
              <button class="mini" data-act="copy169" data-id="${ch.id}">Copiar 16:9</button>
              <button class="mini mini--danger" data-act="del" data-id="${ch.id}">Borrar</button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    function openModal(ch=null){
      editingId = ch ? ch.id : null;
      $("modalTitle").textContent = ch ? "Editar personaje" : "A√±adir personaje";

      $("mName").value = ch?.name || "";
      $("mVersion").value = ch?.version || "";
      $("mType").value = ch?.type || "Otro";
      $("mSeries").value = ch?.series || "";
      $("mSeed").value = ch?.seed || "";
      $("mTags").value = (ch?.tags || []).join(", ");
      $("mApproved").checked = !!ch?.approved;
      $("mDesc").value = ch?.desc || "";
      $("mP916").value = ch?.p916 || "";
      $("mP169").value = ch?.p169 || "";

      $("mImageFile").value = "";
      if(ch?.imageDataUrl){
        $("mPreview").src = ch.imageDataUrl;
        $("mPreview").style.display = "block";
        $("mNoImg").style.display = "none";
      }else{
        $("mPreview").style.display = "none";
        $("mNoImg").style.display = "block";
      }

      $("modalBackdrop").dataset.open = "true";
      $("modalBackdrop").setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      $("modalBackdrop").dataset.open = "false";
      $("modalBackdrop").setAttribute("aria-hidden", "true");
      editingId = null;
    }

    function upsertCharacter(data){
      const idx = LIB.findIndex(x => x.id === data.id);
      if(idx >= 0){
        LIB[idx] = {...LIB[idx], ...data, updatedAt: now()};
      }else{
        LIB.unshift({...data, createdAt: now(), updatedAt: now()});
      }
      saveLibrary(LIB);
      renderLibrary();
    }

    function deleteCharacter(id){
      LIB = LIB.filter(x => x.id !== id);
      saveLibrary(LIB);
      renderLibrary();
    }

    function exportJson(){
      const payload = {
        app: "ConexionBiblicaCharacterLibrary",
        version: 2,
        exportedAt: new Date().toISOString(),
        items: LIB
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "conexion_biblica_biblioteca_personajes.json";
      a.click();
      URL.revokeObjectURL(a.href);
      toast("Exportado ‚úÖ");
    }

    function importJsonFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          const items = Array.isArray(obj) ? obj : (obj.items || []);
          if(!Array.isArray(items)) throw new Error("Formato inv√°lido");
          const normalized = items.map(x => ({
            id: x.id || uid(),
            name: x.name || "Sin nombre",
            version: x.version || "",
            type: x.type || "Otro",
            series: x.series || "",
            seed: x.seed || "",
            tags: Array.isArray(x.tags) ? x.tags : (String(x.tags||"").split(",").map(s=>s.trim()).filter(Boolean)),
            approved: !!x.approved,
            desc: x.desc || "",
            p916: x.p916 || "",
            p169: x.p169 || "",
            imageDataUrl: x.imageDataUrl || "",
            createdAt: x.createdAt || now(),
            updatedAt: x.updatedAt || now()
          }));
          LIB = normalized;
          saveLibrary(LIB);
          renderLibrary();
          toast("Importado ‚úÖ");
        }catch(e){
          alert("No pude importar el archivo: " + e.message);
        }
      };
      reader.readAsText(file);
    }

    function genPromptsFromFields(fields, pb){
      const base = (pb.baseStyle || "").trim();
      const neg = (pb.negative || "").trim();

      const name = (fields.name || "").trim();
      const ver = (fields.version || "").trim();
      const type = (fields.type || "").trim();
      const series = (fields.series || "").trim();
      const seed = (fields.seed || "").trim();
      const desc = (fields.desc || "").trim();

      const identityBits = [
        name ? name : "",
        ver ? ver : "",
        type ? ("tipo " + type) : "",
        series ? ("contexto " + series) : "",
        seed ? ("seed " + seed) : "",
        desc ? desc : ""
      ].filter(Boolean).join(", ");

      const common = [
        base,
        identityBits,
        "composici√≥n centrada, enfoque cinematogr√°fico, detalles faciales consistentes",
        "sin texto"
      ].filter(Boolean).join(", ");

      const p916 = [
        common,
        "plano medio, c√°mara 35mm, vertical 9:16"
      ].join(", ") + (neg ? `. Negativo: ${neg}` : "");

      const p169 = [
        common,
        "plano medio, c√°mara 35mm, horizontal 16:9"
      ].join(", ") + (neg ? `. Negativo: ${neg}` : "");

      return {p916, p169};
    }

    (function init(){
      $("year").textContent = new Date().getFullYear();

      // Landing
      let landing = loadLanding();
      applyLanding(landing);
      fillLandingSettings(landing);

      $("btnSaveLanding").addEventListener("click", () => {
        const updated = {
          ...landing,
          headline: $("setHeadline").value.trim(),
          subheadline: $("setSubheadline").value.trim(),
          primaryCtaText: $("setCta1Text").value.trim(),
          primaryCtaUrl: $("setCta1Url").value.trim(),
          secondaryCtaText: $("setCta2Text").value.trim(),
          secondaryCtaUrl: $("setCta2Url").value.trim(),
          seriesLinks: {
            quiz: $("setSeriesQuizUrl").value.trim(),
            diccionario: $("setSeriesDiccionarioUrl").value.trim(),
            shorts: $("setSeriesShortsUrl").value.trim()
          },
          rules: $("setRules").value.split("\n").map(x=>x.trim()).filter(Boolean),
          featuredVideos: landing.featuredVideos || (window.CB_CONFIG?.landing?.featuredVideos || [])
        };
        landing = updated;
        saveLanding(updated);
        applyLanding(updated);
        fillLandingSettings(updated);
        toast("Guardado ‚úÖ");
      });

      $("btnResetLanding").addEventListener("click", () => {
        landing = defaultLandingFromConfig();
        resetLanding();
        landing = loadLanding();
      });

      $("btnCopyLanding").addEventListener("click", () => copyText(landingToDescriptionText(landing)));

      // Prompt base
      const pb = loadPromptBase();
      $("baseStyle").value = pb.baseStyle || "";
      $("negative").value = pb.negative || "";
      $("btnSavePromptBase").addEventListener("click", () => {
        const next = { baseStyle: $("baseStyle").value.trim(), negative: $("negative").value.trim() };
        savePromptBase(next);
        toast("Base guardada ‚úÖ");
      });

      // Library
      LIB = loadLibrary();
      const pb2 = loadPromptBase();
      LIB = LIB.map(ch => {
        if((!ch.p916 && !ch.p169) && (ch.desc || ch.name)){
          const g = genPromptsFromFields(ch, pb2);
          return {...ch, p916: g.p916, p169: g.p169};
        }
        return ch;
      });
      saveLibrary(LIB);
      renderLibrary();

      // Tabs
      $("tabLanding").addEventListener("click", ()=> setTab("landing"));
      $("tabLibrary").addEventListener("click", ()=> setTab("biblioteca"));
      function resolveHash(){
        const h = (location.hash || "#landing").toLowerCase();
        if(h.includes("biblio")) setTab("biblioteca");
        else setTab("landing");
      }
      window.addEventListener("hashchange", resolveHash);
      resolveHash();

      // Filters
      $("search").addEventListener("input", renderLibrary);
      $("sort").addEventListener("change", renderLibrary);
      $("filterType").addEventListener("change", renderLibrary);
      $("filterApproved").addEventListener("change", renderLibrary);

      // Add / Export / Import / Clear
      $("btnAddNew").addEventListener("click", () => openModal(null));
      $("btnExport").addEventListener("click", exportJson);
      $("btnImport").addEventListener("click", ()=> $("importFile").click());
      $("importFile").addEventListener("change", (e) => {
        const f = e.target.files?.[0];
        if(f) importJsonFile(f);
        e.target.value = "";
      });
      $("btnClearAll").addEventListener("click", () => {
        if(confirm("¬øSeguro que quieres vaciar toda la biblioteca?")){
          LIB = [];
          saveLibrary(LIB);
          renderLibrary();
          toast("Biblioteca vac√≠a ‚úÖ");
        }
      });

      // Upload settings
      $("imgMax").value = String(window.CB_CONFIG?.library?.maxImagePx || 768);
      $("imgQ").value = String(window.CB_CONFIG?.library?.imageQuality || 0.82);

      // Multi-upload quick add
      $("fileUpload").addEventListener("change", async (e) => {
        const files = Array.from(e.target.files || []);
        if(!files.length) return;

        const maxPx = parseInt($("imgMax").value, 10);
        const quality = parseFloat($("imgQ").value);
        const mime = (window.CB_CONFIG?.library?.imageFormat) || "image/webp";

        for(const file of files){
          const name = file.name.replace(/\.[^.]+$/, "");
          const dataUrl = await fileToCompressedDataUrl(file, maxPx, mime, quality);
          upsertCharacter({
            id: uid(),
            name,
            version: "",
            type: "Otro",
            series: "",
            seed: "",
            tags: [],
            approved: false,
            desc: "",
            p916: "",
            p169: "",
            imageDataUrl: dataUrl
          });
        }
        e.target.value = "";
        toast("Subido(s) ‚úÖ");
      });

      // Card actions
      $("libGrid").addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        const act = btn.dataset.act;
        const id = btn.dataset.id;
        const ch = LIB.find(x => x.id === id);
        if(!ch) return;

        if(act === "edit") openModal(ch);
        if(act === "copy916") copyText(ch.p916 || "");
        if(act === "copy169") copyText(ch.p169 || "");
        if(act === "del"){
          if(confirm("¬øBorrar este personaje?")) deleteCharacter(id);
        }
      });

      // Modal
      $("btnCloseModal").addEventListener("click", closeModal);
      $("modalBackdrop").addEventListener("click", (e) => {
        if(e.target === $("modalBackdrop")) closeModal();
      });

      $("btnCopy916").addEventListener("click", () => copyText($("mP916").value || ""));
      $("btnCopy169").addEventListener("click", () => copyText($("mP169").value || ""));

      $("btnGenPrompts").addEventListener("click", () => {
        const pbNow = loadPromptBase();
        const fields = {
          name: $("mName").value,
          version: $("mVersion").value,
          type: $("mType").value,
          series: $("mSeries").value,
          seed: $("mSeed").value,
          desc: $("mDesc").value
        };
        const g = genPromptsFromFields(fields, pbNow);
        $("mP916").value = g.p916;
        $("mP169").value = g.p169;
        toast("Generado ‚úÖ");
      });

      $("btnClearPrompts").addEventListener("click", () => {
        $("mP916").value = "";
        $("mP169").value = "";
        toast("Prompts vac√≠os ‚úÖ");
      });

      $("mImageFile").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if(!f) return;

        const maxPx = parseInt($("imgMax").value, 10);
        const quality = parseFloat($("imgQ").value);
        const mime = (window.CB_CONFIG?.library?.imageFormat) || "image/webp";

        const dataUrl = await fileToCompressedDataUrl(f, maxPx, mime, quality);
        $("mPreview").src = dataUrl;
        $("mPreview").style.display = "block";
        $("mNoImg").style.display = "none";
        $("mPreview").dataset.pending = dataUrl;
      });

      $("btnSaveChar").addEventListener("click", () => {
        const id = editingId || uid();
        const tags = $("mTags").value.split(",").map(s=>s.trim()).filter(Boolean);

        const existing = LIB.find(x => x.id === id);
        const pendingImg = $("mPreview").dataset.pending || "";
        const imageDataUrl = pendingImg || existing?.imageDataUrl || "";
        delete $("mPreview").dataset.pending;

        upsertCharacter({
          id,
          name: $("mName").value.trim() || "Sin nombre",
          version: $("mVersion").value.trim(),
          type: $("mType").value || "Otro",
          series: $("mSeries").value.trim(),
          seed: $("mSeed").value.trim(),
          tags,
          approved: $("mApproved").checked,
          desc: $("mDesc").value.trim(),
          p916: $("mP916").value.trim(),
          p169: $("mP169").value.trim(),
          imageDataUrl
        });

        closeModal();
        toast("Guardado ‚úÖ");
      });
    })();
  </script>
</body>
</html>
